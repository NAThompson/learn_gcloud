\documentclass[9pt]{beamer}
\usepackage{minted}
%\usemintedstyle{manni}
\usemintedstyle{murphy}
\usepackage{hyperref}
\hypersetup{
colorlinks=true,
urlcolor=blue
}
\usepackage{graphicx}

\begin{document}
\title{Basic Introduction to gcloud}
\author{Nick Thompson} 
\date{\today}

\frame{\titlepage}

\begin{frame}[fragile]
  \frametitle{Goals of this discussion}
  \pause
  \begin{itemize}
  \item Learn how to rent CPUs and RAM from google
    \pause
  \item Learn how to rent persistent disks
    \pause
  \item Learn how to control expenses
    \pause
  \item Learn how to manage permissions
    \pause
  \item Learn how to create teams of identical VMs
    \pause
  \item Learn how to autoscale nodes based on load
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
\frametitle{Getting started:}
\begin{minted}{bash}
 $ curl https://sdk.cloud.google.com | bash
  $ exec -l $SHELL
  $ gcloud init
  $ gcloud auth login
  $ firefox https://console.developers.google.com
\end{minted}
You don't need a gmail account to use gcloud, but you must enter an email into gcloud that then becomes your google account login.
\end{frame}

\begin{frame}[fragile]
  \frametitle{Starting a Project}
  \begin{figure}
    \includegraphics[scale=0.2]{figures/CreateProject.png}
  \end{figure}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Starting a Project}
  Each project has
  \pause
  \begin{itemize}
  \item its bill separated in the invoice (1 billing account $\mapsto$ many project accounts)
    \pause
  \item its own VMs
    \pause
  \item its own persistent disks
    \pause
  \item its own users with their associated permissions.
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Starting a Project}
  Multiple people can be listed as project owners, or given read access, or read/write access to the project:
  \begin{figure}
    \includegraphics[scale=0.2]{figures/AddProjectOwner.png}
  \end{figure}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Starting a project}
  You need tell the gcloud command-line tool that you've created a new project:
  \begin{minted}{bash}
    $ gcloud config list
    [core]
    account = nickadamthompson@gmail.com
    disable_usage_reporting = True
    project = graphical-cairn-97618 
    [meta]
    active_config = default
  \end{minted}
  If the \texttt{project} field has the wrong value, you need to set it:
  \begin{minted}{bash}
    $ gcloud config set project learngcloud-1184
  \end{minted}
  Note that you don't set the project \emph{name}, you set the project \emph{ID}.
\end{frame}


\begin{frame}[fragile]
  \frametitle{Setting up instances (=VMs)}
  \begin{figure}
    \includegraphics[scale=0.3]{figures/CreateInstance.png}
  \end{figure}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Setting up instances}
  Things to choose at this point:
  \pause
  \begin{itemize}
  \item Number of cores (max 32)
    \pause
  \item amount of RAM (unlimited, it seems, but 200GB is supported for sure)
    \pause
  \item size of disk, SSD (max 10TB) or spinning (max 10TB) 
    \pause
  \item Operating system (Ubuntu, Centos, CoreOS), or choose a VM snapshot
    \pause
  \item Firewall rules
    \pause
  \item Whether to use static or ephemeral IP addresses (static IPs cost money!)
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Setting up and instance}
  Aside: If you need more than 10TB of disk space, you need to fill out the \href{https://docs.google.com/a/google.com/forms/d/1vb2MkAr9JcHrp6myQ3oTxCyBv2c7Iyc5wqIKqE3K4IE/viewform}{Google Compute Engine Quota Change Request Form}.
\end{frame}

\begin{frame}[fragile]
  \frametitle{Setting up an instance}
  Once you create a VM, you'll be assigned an external IP address and can see the load on your server:
  \begin{figure}
    \includegraphics[scale=0.2]{figures/VMUp.png}
  \end{figure}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Setting up an instance}
  To access your VM, use:
  \begin{minted}{bash}
    $ gcloud compute ssh myfirstvm --zone us-central1-b
  \end{minted}
  (Don't choose the wrong zone or else your instance won't be found!)

  This is really a wrapper script around the IP address of your instance:
  \begin{minted}{bash}
    $ ssh -i ~/.ssh/google_compute_engine 104.154.88.253
  \end{minted}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Setting up an instance}
  For every console action, there is a equivalent gcloud command. So, for example, to set up an instance, you could type
  \begin{minted}{bash}
    $ gcloud compute instances create mysecondvm --image ubuntu-15-10 --zone us-central1-b
  \end{minted}
  This is useful for scripting.
\end{frame}

\begin{frame}[fragile]
  \frametitle{Editing Firewalls}
  Google cloud has a set of default firewall rules that you might like to edit:
  \begin{figure}
    \includegraphics[scale=0.2]{figures/DefaultFirewall.png}
  \end{figure}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Editing Firewalls}
  The default rules are of course reflected in the port scan:
  \begin{minted}{bash}
    $ nmap -p 0-10000 104.154.88.253

    Starting Nmap 6.47 ( http://nmap.org ) at 2016-01-08 17:43 CST
    Nmap scan report for 253.88.154.104.bc.googleusercontent.com (104.154.88.253)
    Host is up (0.040s latency).
    Not shown: 9997 filtered ports
    PORT     STATE  SERVICE
    22/tcp   open   ssh
    80/tcp   closed http
    443/tcp  closed https
    3389/tcp closed ms-wbt-server
  \end{minted}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Editing firewalls}
  This allows traffic from AMQP:
  \begin{figure}
    \includegraphics[scale=0.2]{figures/DefineFirewall.png}
  \end{figure}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Editing firewalls}
  Command line to allow AMQP on port 5672 from any source IP, use the command
  \begin{minted}{bash}
    $ gcloud compute firewall-rules create default-allow-amqp --allow tcp:5672
    Created [https://www.googleapis.com/compute/v1/projects/learngcloud-1184/global/firewalls/default-allow-amqp].
    NAME               NETWORK SRC_RANGES RULES    SRC_TAGS TARGET_TAGS
    default-allow-amqp default 0.0.0.0/0  tcp:5672
  \end{minted}
  Creating a firewall rule applies it to all live instances in the project.
\end{frame}

\begin{frame}[fragile]
  \frametitle{Persistent Disks}
  If you need storage that is not chained to a particular VM, then you need to use ``buckets'':
  \begin{figure}
    \includegraphics[scale=0.2]{figures/Buckets.png}
  \end{figure}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Persistent Disks}
  In order to manage persistent disks from the command line, use the gsutil utility:
  \begin{minted}{bash}
    $ pip install gsutil
    $ gsutil mb gs://myfirstbucket
    Creating gs://myfirstbucket/...
    ServiceException: 409 Bucket myfirstbucket already exists.
    $ gsutil mb gs://myfirstbucket123
    Creating gs://myfirstbucket123/...
    $ gsutil cp talk.log gs://myfirstbucket123
    Copying file://talk.log [Content-Type=application/octet-stream]...
    Uploading   gs://myfirstbucket123/talk.log:                      43.94 KiB/43.94 KiB
    ~/learn_gcloud$ gsutil ls
    gs://myfirstbucket123/
    $ gsutil ls -l gs://myfirstbucket123
    44993  2016-01-09T21:19:30Z  gs://myfirstbucket123/talk.log
    TOTAL: 1 objects, 44993 bytes (43.94 KiB)
  \end{minted}
  We can see that bucket names need to be globally unique.
\end{frame}

\begin{frame}[fragile]
  \frametitle{Persistent Disks}
  \begin{itemize}
  \item gcloud buckets are encrypted on disk
  \item gcloud buckets are accessible outside zones
  \item Uploads to gcloud buckets are atomic and considered successful once the info is stored in multiple datacenters.
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Persistent Disks}
  Mounting a bucket to an instance takes a little work (\href{https://github.com/googlecloudplatform/gcsfuse/blob/master/docs/installing.md}{instructions}):
  \begin{minted}{bash}
    $ curl -L -O https://github.com/GoogleCloudPlatform/gcsfuse/releases/download/v0.15.0/gcsfuse_0.15.0_amd64.deb
    $ sudo dpkg --install gcsfuse_0.15.0_amd64.deb
    $ mkdir mount_point
    $ gcsfuse myfirstbucket123 mount_point
    $ time ls mount_point
    talk.log

    real0m2.557s
    $ touch mount_point/file.txt
    touch: cannot touch ‘mount_point/file.txt’: Input/output error
  \end{minted}
  These networked disks are \emph{incredibly slow}, even read-only.
\end{frame}

\begin{frame}[fragile]
  \frametitle{Persistent Disks}
  The need to access to persistent disks via APIs in various languages is very common. gcloud has Python, Node.js, Java, and Ruby bindings. Let's see an example in Python:
  \begin{minted}{python}
    $ pip3 install git+https://github.com/GoogleCloudPlatform/gcloud-python.git
    $ python3 -q
    >>> from gcloud import storage
    >>> client = storage.Client(project='learngloud-1184', credentials='')
  \end{minted}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Final Advice}
  \begin{itemize}
  \item Cloud providers are competing on price, offering the same commercial hardware; this business is difficult.
  \item Their strategy is to lock in their customers via making wrapper scripts around open-source softwares and trying to convince people to use them (e.g., gcloud sql = wrapped mysql) 
  \item If you use these, you will have no hope of migrating your stack to another provider, and they can charge you whatever they want.
  \end{itemize}
\end{frame}

\end{document}
